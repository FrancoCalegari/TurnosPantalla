<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Display de Turnos</title>
  <link rel="stylesheet" href="display.css">
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="hora" id="hora"></div>
    <div class="logo">
      <img src="./Clinica Demo.png" alt="Logo" class="logo-img">
    </div>
    <div class="clima" id="clima">Clima: Cargando...</div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="contenedor">
    <section class="panel panel-izq">
      <h2>Turnos en curso</h2>
      <ul id="historial"></ul>
    </section>

    <section class="panel panel-der">
      <h2>Turno actual</h2>
      <div id="turno-actual" class="turno-actual">---</div>
      <audio id="notificacion" src="sounds/notificacion.mp3"></audio>

      <h2>Pr√≥ximos turnos</h2>
      <ul id="siguientes"></ul>
    </section>
  </main>

  <script>
const turnoActualEl = document.getElementById("turno-actual");
const siguientesEl = document.getElementById("siguientes");
const historialEl = document.getElementById("historial");
const notificacion = document.getElementById("notificacion");

// Precarga del audio
window.addEventListener("DOMContentLoaded", () => {
  notificacion.load();
});

// Cache en memoria
let cache = {
  turnoActual: null,
  historial: [],
  turnos: []
};

// Actualizar hora
function actualizarHora() {
  const ahora = new Date();
  document.getElementById("hora").innerText = ahora.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}
setInterval(actualizarHora, 1000);
actualizarHora();

// Obtener clima
async function obtenerClima() {
  const apiKey = "TuApiKeyActivada"; // üîë
  const lat = -34.6037;
  const lon = -58.3816;
  const url = `https://weather.googleapis.com/v1/forecast/days:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}&days=1`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error en la API");
    const data = await res.json();

    const hoy = data.forecastDays?.[0];
    if (hoy) {
      const min = hoy.minTemperature?.degrees ?? "--";
      const max = hoy.maxTemperature?.degrees ?? "--";
      const descripcion =
        hoy.daytimeForecast?.weatherCondition?.description?.text ??
        hoy.nighttimeForecast?.weatherCondition?.description?.text ??
        "Sin datos";

      document.getElementById("clima").innerText =
        `Clima: ${min}¬∞C - ${max}¬∞C, ${descripcion}`;
    }
  } catch (e) {
    console.error("Error obteniendo clima:", e);
    document.getElementById("clima").innerText = "Clima: No disponible";
  }
}
obtenerClima();
setInterval(obtenerClima, 600000);

// Refrescar con cache
setInterval(async () => {
  try {
    // Turno actual
    const resActual = await fetch("/turno-actual");
    const turno = await resActual.json();
    if (JSON.stringify(turno) !== JSON.stringify(cache.turnoActual)) {
      if (cache.turnoActual && turno.numero !== cache.turnoActual.numero) {
        notificacion.play().catch(()=>{});
      }
      turnoActualEl.innerText = turno?.numero ?? "---";
      turnoActualEl.dataset.num = turno?.numero ?? "";
      cache.turnoActual = turno;
    }

    // Historial
    const resHist = await fetch("/historial");
    const historial = await resHist.json();
    if (JSON.stringify(historial) !== JSON.stringify(cache.historial)) {
      historialEl.innerHTML = historial.map(t =>
        `<li>${t.numero}</li>`).join("");
      cache.historial = historial;
    }

    // Pr√≥ximos turnos
    const resTodos = await fetch("/turnos");
    const todos = await resTodos.json();
    if (JSON.stringify(todos.turnos) !== JSON.stringify(cache.turnos)) {
      siguientesEl.innerHTML = todos.turnos.slice(0, 5).map(t =>
        `<li>${t.numero}</li>`).join("");
      cache.turnos = todos.turnos;
    }
  } catch (err) {
    console.error("Error actualizando turnos:", err);
  }
}, 3000);

// Habilitar sonido tras interacci√≥n
function habilitarSonido() {
  notificacion.play().catch(()=>{});
  document.removeEventListener("click", habilitarSonido);
  document.removeEventListener("keydown", habilitarSonido);
}
document.addEventListener("click", habilitarSonido);
document.addEventListener("keydown", habilitarSonido);
  </script>
</body>
</html>
