<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Display de Turnos</title>
  <link rel="stylesheet" href="display.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- HEADER -->
  <header class="header">

    <div class="hora" id="hora"></div>
    <div class="logo">
      <img src="./Clinica Demo.png" alt="Logo" class="logo-img">
    </div>
    <div class="clima" id="clima">Clima: Cargando...</div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="contenedor">
    <section class="panel panel-izq">
      <h2>Turnos en curso</h2>
      <ul id="historial"></ul>
    </section>

    <section class="panel panel-der">
      <h2>Turno actual</h2>
      <div id="turno-actual" class="turno-actual">---</div>
      <audio id="notificacion" src="sounds/notificacion.mp3"></audio>

      <h2>Pr√≥ximos turnos</h2>
      <ul id="siguientes"></ul>
    </section>
  </main>

  <script>

 const socket = io();

const turnoActualEl = document.getElementById("turno-actual");
const siguientesEl = document.getElementById("siguientes");
const historialEl = document.getElementById("historial");
const notificacion = document.getElementById("notificacion");

// Reproducir sonido al cargar el DOM (precarga)
window.addEventListener("DOMContentLoaded", () => {
  notificacion.load();
});

// Actualizar hora en vivo
function actualizarHora() {
  const ahora = new Date();
  document.getElementById("hora").innerText = ahora.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });
}
setInterval(actualizarHora, 1000);
actualizarHora();


// Obtener clima desde Google Weather API
// Obtener clima desde Google Weather API
async function obtenerClima() {
  const apiKey = "TuApiKeyActivada"; // üîë Reemplaza con tu clave
  const lat = -34.6037; // Ejemplo: Buenos Aires
  const lon = -58.3816;

  const url = `https://weather.googleapis.com/v1/forecast/days:lookup?key=${apiKey}&location.latitude=${lat}&location.longitude=${lon}&days=1`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error en la API");
    const data = await res.json();

    // Extraer el pron√≥stico de hoy
    const hoy = data.forecastDays?.[0];
    if (hoy) {
      const min = hoy.minTemperature?.degrees ?? "--";
      const max = hoy.maxTemperature?.degrees ?? "--";
      const descripcion =
        hoy.daytimeForecast?.weatherCondition?.description?.text ??
        hoy.nighttimeForecast?.weatherCondition?.description?.text ??
        "Sin datos";

      document.getElementById("clima").innerText =
        `Clima: ${min}¬∞C - ${max}¬∞C, ${descripcion}`;
    } else {
      document.getElementById("clima").innerText = "Clima: No disponible";
    }
  } catch (e) {
    console.error("Error obteniendo clima:", e);
    document.getElementById("clima").innerText = "Clima: No disponible";
  }
}

// Llamar al cargar y actualizar cada 10 minutos
obtenerClima();
setInterval(obtenerClima, 600000);


// Refrescar cada segundo
setInterval(async () => {
  // Turno actual
  const resActual = await fetch("/turno-actual");
  const turno = await resActual.json();
  if (turno && turno.numero) {
    const displayNum = turno.tipo === "sin-turno"
      ? `${turno.numero}`
      : `${turno.numero}`;
    if (turnoActualEl.dataset.num !== String(turno.numero)) {
      notificacion.play();
    }
    turnoActualEl.innerText = displayNum;
    turnoActualEl.dataset.num = turno.numero;
  }

  // Historial
  const resHist = await fetch("/historial");
  const historial = await resHist.json();
  historialEl.innerHTML = historial.map(t =>
    `<li>${t.tipo === "sin-turno" ? `${t.numero}` : `${t.numero}`}</li>`
  ).join("");

  // Pr√≥ximos turnos (cola)
  const resTodos = await fetch("/turnos");
  const todos = await resTodos.json();
  siguientesEl.innerHTML = todos.turnos.slice(0, 5).map(t =>
    `<li>${t.tipo === "sin-turno" ? `${t.numero}` : `${t.numero}`}</li>`
  ).join("");
}, 1000);


function habilitarSonido() {
  notificacion.play().catch(()=>{});
  document.removeEventListener("click", habilitarSonido);
  document.removeEventListener("keydown", habilitarSonido);
}
document.addEventListener("click", habilitarSonido);
document.addEventListener("keydown", habilitarSonido);




  </script>
</body>
</html>
